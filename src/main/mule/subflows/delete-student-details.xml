<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:validation="http://www.mulesoft.org/schema/mule/validation" xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
	xmlns:db="http://www.mulesoft.org/schema/mule/db"
	xmlns:tracking="http://www.mulesoft.org/schema/mule/ee/tracking" xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/ee/tracking http://www.mulesoft.org/schema/mule/ee/tracking/current/mule-tracking-ee.xsd
http://www.mulesoft.org/schema/mule/db http://www.mulesoft.org/schema/mule/db/current/mule-db.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
http://www.mulesoft.org/schema/mule/validation http://www.mulesoft.org/schema/mule/validation/current/mule-validation.xsd">
	<sub-flow name="delete-student-details-sub-flow" doc:id="96371f7d-8f7d-4769-b8c0-4537aa231f4c" >
		<until-successful maxRetries="3" doc:name="Until Successful" doc:id="ad95ce42-01f5-4eac-9e96-30eab8ab8eae" millisBetweenRetries="5000">
			<try doc:name="Try" doc:id="fc39a5c2-337c-42ae-bf10-634087251f24" >
				<db:delete doc:name="Delete" doc:id="bf86b874-4b14-4033-910a-7171694fab94" config-ref="Database_Config">
			<db:sql><![CDATA[DELETE FROM students WHERE id= :id]]></db:sql>
			<db:input-parameters><![CDATA[#[{
	id:vars.id
}]]]></db:input-parameters>
		</db:delete>
				<logger level="INFO" doc:name="Logger" doc:id="e4208caf-d6a0-4a0b-bc83-8e341b4087cd" message="#[payload]"/>
				<ee:transform doc:name="Transform Message" doc:id="155e4d43-ba21-4f64-a292-5c22bf9fb6cb" >
					<ee:message >
						<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
if(payload == 0)
	{
    "errorCode": 404,
    "message": "Student with ID:"++(vars.id default "404")++" not found."
	}
else
{
	"statusCode":200,
	"message": "Student with ID:"++(vars.id default "")++"deleted successful."
}]]></ee:set-payload>
					</ee:message>
					<ee:variables >
						<ee:set-variable variableName="httpStatus" ><![CDATA[if(payload==0) 404 else 200]]></ee:set-variable>
					</ee:variables>
				</ee:transform>
				<error-handler >
					<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="eb7e31ce-b6eb-4ca5-8980-6046e7a6bc51" type="DB:CONNECTIVITY" >
						<logger level="WARN" doc:name="Logger" doc:id="626f87a2-cedd-4aa5-8bfa-b588b1ace12c" message='#["Connecting issue to Database ...Retrying...."]' />
						<ee:transform doc:name="Transform Message" doc:id="4d34dd8a-7801-43b6-8323-914113dd4b66" >
							<ee:message >
								<ee:set-payload ><![CDATA[%dw 2.0
output application/java
---
{
  errorType: error.errorType.identifier,
  message_from_system:error.description,
  message: "Student with ID already exists. Please use a unique ID."
}]]></ee:set-payload>
							</ee:message>
							<ee:variables >
								<ee:set-variable variableName="httpStatus" ><![CDATA[500]]></ee:set-variable>
							</ee:variables>
						</ee:transform>
					</on-error-propagate>
					<on-error-continue enableNotifications="true" logException="true" doc:name="On Error Continue" doc:id="5f92afd7-f17d-47a4-a7e5-f21fe182971b" type="DB:QUERY_EXECUTION" >
						<logger level="INFO" doc:name="Logger" doc:id="fc29b120-d97d-435f-b469-fbdb15695195" message="#[payload]" />
						<ee:transform doc:name="Transform Message" doc:id="18ef3fc2-41f1-46a9-8d59-d4ecc054d7e0" >
							<ee:message >
								<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
  errorType: error.errorType.identifier,
  message_from_system:error.description
}]]></ee:set-payload>
							</ee:message>
							<ee:variables >
							</ee:variables>
						</ee:transform>
					</on-error-continue>
				</error-handler>
			</try>
		</until-successful>
	</sub-flow>
</mule>
